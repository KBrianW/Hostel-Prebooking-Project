{% extends 'base.html' %}
{% block title %}Manage Bookings - ANU Hostel System{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-0" style="font-family:'Poppins',sans-serif;">Manage Bookings</h3>
                <small class="text-muted">Verify payments, assign rooms, and manage bookings</small>
            </div>
        </div>
        <!-- Search Bar -->
        <div class="mt-3">
            <form method="GET" class="d-flex gap-2">
                <input type="text" name="search" class="form-control" placeholder="Search by student name or registration number..." value="{{ search_query }}" style="max-width: 400px;">
                <button type="submit" class="btn btn-light">
                    <i class="bi bi-search"></i> Search
                </button>
                {% if search_query %}
                    <a href="{% url 'manage_bookings' %}" class="btn btn-outline-light">
                        <i class="bi bi-x-circle"></i> Clear
                    </a>
                {% endif %}
            </form>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    {% if bookings %}
        <div class="card p-4">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Reg No</th>
                            <th>Room</th>
                            <th>Status</th>
                            <th>Payment Info</th>
                            <th>Total Paid</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                            <tr>
                                <td>{{ booking.student.user.get_full_name }}</td>
                                <td>{{ booking.student.reg_no }}</td>
                                <td>
                                    {% if booking.room %}
                                        {{ booking.room.hostel.name }} - {{ booking.room.room_number }}
                                    {% else %}
                                        <span class="text-muted">No room assigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if booking.status == 'paid' %}
                                        <span class="badge bg-success">Fully Paid</span>
                                    {% elif booking.status == 'prebooked' %}
                                        <span class="badge bg-warning text-dark">Pre-booked</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Expired</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if booking.payments.exists %}
                                        <small>
                                            {% for payment in booking.payments.all %}
                                                <div>Ksh {{ payment.amount|floatformat:2 }} 
                                                    {% if payment.verified %}
                                                        <span class="badge bg-success">âœ“</span>
                                                    {% else %}
                                                        <span class="badge bg-warning">Pending</span>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </small>
                                    {% else %}
                                        <span class="text-muted">No payments</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>Ksh {{ booking.get_total_paid|floatformat:2 }}</strong> / 
                                    Ksh {{ booking.get_total_due|floatformat:2|default:"0.00" }}
                                </td>
                                <td>{{ booking.date_booked|date:"M d, Y" }}</td>
                                <td>
                                    <div class="btn-group-vertical btn-group-sm" role="group">
                                        {% if booking.status == "prebooked" %}
                                            {% if booking.payments.exists %}
                                                {% for payment in booking.payments.all %}
                                                    {% if not payment.verified %}
                                                        <form method="POST" class="mb-1">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="booking_id" value="{{ booking.id }}">
                                                            <input type="hidden" name="payment_id" value="{{ payment.id }}">
                                                            <input type="hidden" name="action" value="verify">
                                                            <button type="submit" class="btn btn-success btn-sm">Verify Payment (Ksh {{ payment.amount|floatformat:2 }})</button>
                                                        </form>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            
                                            <button type="button" class="btn btn-info btn-sm mb-1" data-bs-toggle="modal" data-bs-target="#assignRoomModal{{ booking.id }}">
                                                Assign/Change Room
                                            </button>
                                            
                                            <button type="button" class="btn btn-danger btn-sm mb-1" data-bs-toggle="modal" data-bs-target="#removeStudentModal{{ booking.id }}">
                                                Remove Student
                                            </button>
                                            
                                            <form method="POST" onsubmit="return confirm('Are you sure you want to release this room?');">
                                                {% csrf_token %}
                                                <input type="hidden" name="booking_id" value="{{ booking.id }}">
                                                <input type="hidden" name="action" value="release">
                                                <button type="submit" class="btn btn-warning btn-sm">Release Room</button>
                                            </form>
                                        {% elif booking.status == "paid" %}
                                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#removeStudentModal{{ booking.id }}">
                                                Remove Student
                                            </button>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Modal for Room Assignment -->
                                    <div class="modal fade" id="assignRoomModal{{ booking.id }}" tabindex="-1">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content bg-dark text-light">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Assign Room to {{ booking.student.user.get_full_name }}</h5>
                                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                                </div>
                                                <form method="POST">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="booking_id" value="{{ booking.id }}">
                                                    <input type="hidden" name="action" value="assign_room">
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label class="form-label">Select Room</label>
                                                            <select name="new_room_id" class="form-select" required>
                                                                <option value="">-- Select a room --</option>
                                                                {% for room in all_rooms %}
                                                                    <option value="{{ room.id }}" {% if booking.room and booking.room.id == room.id %}selected{% endif %}>
                                                                        {{ room.hostel.name }} - Room {{ room.room_number }} 
                                                                        ({{ room.hostel.type }}, Ksh {{ room.price|floatformat:0 }}, 
                                                                        {% if room.is_vacant %}Vacant{% else %}Occupied{% endif %})
                                                                    </option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary">Assign Room</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Modal for Remove Student -->
                                    <div class="modal fade" id="removeStudentModal{{ booking.id }}" tabindex="-1">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content bg-dark text-light">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Remove Student: {{ booking.student.user.get_full_name }}</h5>
                                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                                </div>
                                                <form method="POST" id="removeStudentForm{{ booking.id }}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="booking_id" value="{{ booking.id }}">
                                                    <input type="hidden" name="action" value="remove_student">
                                                    <div class="modal-body">
                                                        <div class="alert alert-warning">
                                                            <strong>Current Booking:</strong><br>
                                                            Student: {{ booking.student.user.get_full_name }} ({{ booking.student.reg_no }})<br>
                                                            Room: {% if booking.room %}{{ booking.room.hostel.name }} - Room {{ booking.room.room_number }}{% else %}No room assigned{% endif %}<br>
                                                            Status: {{ booking.status|title }}<br>
                                                            Total Paid: Ksh {{ booking.get_total_paid_all|floatformat:2 }}
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <label class="form-label">Action</label>
                                                            <select name="remove_action" class="form-select" id="removeAction{{ booking.id }}" onchange="toggleRoomSelection({{ booking.id }})">
                                                                <option value="cancel">Cancel Booking (Refund payments)</option>
                                                                <option value="move">Move to Another Room</option>
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="mb-3" id="newRoomDiv{{ booking.id }}" style="display:none;">
                                                            <label class="form-label">Select New Room</label>
                                                            <select name="new_room_id" class="form-select" id="newRoomSelect{{ booking.id }}">
                                                                <option value="">-- Select a room --</option>
                                                                {% for room in all_rooms %}
                                                                    {% if not booking.room or room.id != booking.room.id %}
                                                                        <option value="{{ room.id }}">
                                                                            {{ room.hostel.name }} - Room {{ room.room_number }} 
                                                                            ({{ room.hostel.type }}, Ksh {{ room.price|floatformat:0 }}, 
                                                                            {% if room.is_vacant %}Vacant{% else %}{{ room.get_occupied_count }}/{{ room.capacity }} Occupied{% endif %})
                                                                        </option>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <label class="form-label">Reason</label>
                                                            <textarea name="reason" class="form-control" rows="3" placeholder="Enter reason for this action..." required>Administrative action</textarea>
                                                        </div>
                                                        
                                                        <div class="alert alert-info">
                                                            <small>
                                                                <strong>Note:</strong> 
                                                                <span id="actionNote{{ booking.id }}">Cancelling will refund all payments to the finance office. The student will receive a notification.</span>
                                                            </small>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-danger">Confirm Action</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <script>
                                    function toggleRoomSelection(bookingId) {
                                        const action = document.getElementById('removeAction' + bookingId).value;
                                        const newRoomDiv = document.getElementById('newRoomDiv' + bookingId);
                                        const newRoomSelect = document.getElementById('newRoomSelect' + bookingId);
                                        const actionNote = document.getElementById('actionNote' + bookingId);
                                        
                                        if (action === 'move') {
                                            newRoomDiv.style.display = 'block';
                                            newRoomSelect.required = true;
                                            actionNote.textContent = 'Moving will change the student\'s room assignment. Payment progress remains unchanged. The student will receive a notification.';
                                        } else {
                                            newRoomDiv.style.display = 'none';
                                            newRoomSelect.required = false;
                                            actionNote.textContent = 'Cancelling will refund all payments to the finance office. The student will receive a notification and can book a new room.';
                                        }
                                    }
                                    </script>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info text-center">No bookings found.</div>
    {% endif %}
</div>
{% endblock %}
